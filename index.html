<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>塔羅占卜</title>
    
    <script src="data.js"></script>

    <style>
        :root {
            --gold: #d4af37; 
            --bg: #0f0f1b;   
            --card-w: 64px;
            --card-h: 108px;
        }

        body {
            background-color: var(--bg);
            background-image: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1b 100%);
            color: #e0e0e0; 
            font-family: -apple-system, "PingFang TC", "Noto Sans TC", sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
        }

        /* 介面與引導 */
        #intro-ui { text-align: center; z-index: 1500; width: 85%; }
        h1 { color: var(--gold); font-size: 2rem; letter-spacing: 6px; margin-bottom: 35px; font-weight: bold; }
        
        .spread-menu { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .spread-btn {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--gold);
            border: 1px solid var(--gold);
            border-radius: 12px;
            font-size: 1.1rem;
            text-align: center; 
            font-weight: 500;
            -webkit-tap-highlight-color: transparent;
        }

        #guide-msg {
            position: fixed;
            top: calc(env(safe-area-inset-top) + 10px);
            width: 100%;
            text-align: center;
            padding: 10px;
            color: var(--gold);
            font-size: 1rem;
            font-weight: bold;
            z-index: 4000;
            display: none;
            text-shadow: 0 0 10px rgba(0,0,0,1);
        }

        /* 卡牌容器 */
        .deck-container { position: relative; width: 100%; height: 100%; display: none; }

        .card {
            width: var(--card-w);
            height: var(--card-h);
            position: absolute;
            left: calc(50% - var(--card-w)/2);
            top: 45%;
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d;
            cursor: pointer;
            z-index: 10;
        }

        .card-inner { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.6s; }

        /* 標籤樣式：側邊直式 */
        .card-label {
            position: absolute;
            top: 50%;
            right: calc(100% + 5px);
            transform: translateY(-50%);
            white-space: nowrap;
            color: var(--gold);
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.5s;
            writing-mode: vertical-lr;
            letter-spacing: 1px;
            text-shadow: 0 1px 3px black;
        }
        .card.flipped .card-label { opacity: 1; }
        .card.flipped .card-inner { transform: rotateY(180deg); }

        /* 處理正逆位圖片旋轉 */
        .card.is-reversed .card-back img { transform: rotate(180deg); }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 6px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-sizing: border-box;
            overflow: hidden;
        }

        /* 牌背：圖片居中修正 */
        .card-front { 
            background: #000; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card-front img {
            width: 120%; 
            height: 120%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .card-back { background: #000; transform: rotateY(180deg); }
        .card-back img { width: 101%; height: 101%; object-fit: cover; display: block; }

        /* 解讀面板：維持原大小與位置，僅供內容捲動 */
        #result-panel {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(10, 10, 20, 0.98);
            padding: 20px 20px calc(env(safe-area-inset-bottom) + 15px) 20px;
            border-top: 1px solid var(--gold);
            display: none;
            z-index: 5000;
            overflow-y: auto;
            max-height: 38vh;
            box-sizing: border-box;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>

    <div id="guide-msg"></div>

    <div id="intro-ui">
        <h1>塔羅占卜</h1>
        <div class="spread-menu">
            <button class="spread-btn" onclick="prepareDeck(1, 'RESULT')">精準預測</button>
            <button class="spread-btn" onclick="prepareDeck(3, 'TIMELINE')">前因後果</button>
            <button class="spread-btn" onclick="prepareDeck(3, 'RELATION')">人際關係</button>
            <button class="spread-btn" onclick="prepareDeck(5, 'CHOICE')">抉擇判斷</button>
        </div>
    </div>

    <div class="deck-container" id="deck"></div>

    <div id="result-panel">
        <div id="resContent"></div>
        <button style="width:100%; margin-top:15px; background:var(--gold); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;" onclick="location.reload()">結束占卜</button>
    </div>

    <script>
        const deckContainer = document.getElementById('deck');
        const guideMsg = document.getElementById('guide-msg');
        let session = { count: 0, type: '', selected: 0, results: [] };
        let cards = [];

        function init() {
            if (typeof tarotDeckData === 'undefined') return;
            const indices = Array.from({length: 22}, (_, i) => i).sort(() => Math.random() - 0.5);
            for (let i = 0; i < 22; i++) {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.idx = indices[i];
                card.innerHTML = `
                    <div class="card-label"></div>
                    <div class="card-inner">
                        <div class="card-face card-front"><img src="back.jpg" class="back-img"></div>
                        <div class="card-face card-back"><img src="${indices[i]}.jpg"></div>
                    </div>`;
                deckContainer.appendChild(card);
                cards.push(card);
            }
        }

        async function prepareDeck(count, type) {
            session = { count, type, selected: 0, results: [] };
            document.getElementById('intro-ui').style.display = 'none';
            deckContainer.style.display = 'block';
            guideMsg.style.display = 'block';
            guideMsg.innerText = "正在進行洗牌儀式...";

            for(let r=0; r<3; r++) {
                cards.forEach((c, i) => {
                    const x = i < 11 ? -80 : 80;
                    const isReversing = Math.random() > 0.5;
                    c.dataset.isBackReversed = isReversing ? "true" : "false";
                    c.style.transform = `translate(${x}px, 0)`;
                    const img = c.querySelector('.back-img');
                    img.style.transform = isReversing ? `rotate(180deg)` : `rotate(0deg)`;
                });
                await new Promise(res => setTimeout(res, 600));
                cards.forEach(c => c.style.transform = `translate(0, 0)`);
                await new Promise(res => setTimeout(res, 500));
            }

            cards.forEach((c, i) => {
                let x, y;
                if (i < 11) {
                    x = (i - 5) * 32;
                    y = 100;
                } else {
                    x = (i - 16) * 32;
                    y = 210;
                }
                c.style.transform = `translate(${x}px, ${y}px) rotate(0deg)`;
                c.onclick = () => selectCard(c);
            });
            updateGuide();
        }

        function updateGuide() {
            const labels = getLabels(session.type);
            guideMsg.innerText = session.selected < session.count ? 
                `請抽出「${labels[session.selected]}」的牌` : `揭示中...`;
        }

        function selectCard(card) {
            if (card.classList.contains('flipped') || session.selected >= session.count) return;

            const isRev = card.dataset.isBackReversed === "true"; 
            const data = tarotDeckData[card.dataset.idx];
            const labels = getLabels(session.type);
            const currentLabel = labels[session.selected];
            
            session.selected++;
            card.querySelector('.card-label').innerText = currentLabel;
            if (isRev) card.classList.add('is-reversed');
            card.classList.add('flipped');

            let pos = { x: 0, y: -160 }; 

            if (session.type === 'TIMELINE') {
                pos.x = (session.selected - 2) * 85;
                pos.y = -160;
            } 
            else if (session.type === 'RELATION') {
                if (session.selected === 1) pos = { x: -90, y: -160 };
                if (session.selected === 2) pos = { x: 90, y: -160 };
                if (session.selected === 3) pos = { x: 0, y: -160 };
            } 
            else if (session.type === 'CHOICE') {
                if (session.selected === 1) pos = { x: 0, y: -80 };
                if (session.selected === 2) pos = { x: -85, y: -170 };
                if (session.selected === 3) pos = { x: -85, y: -290 };
                if (session.selected === 4) pos = { x: 85, y: -170 };
                if (session.selected === 5) pos = { x: 85, y: -290 };
            }

            card.style.zIndex = 1000 + session.selected;
            card.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(1.0) rotate(0deg)`;

            session.results.push({ label: currentLabel, name: data.n, pos: isRev ? '逆位' : '正位', desc: isRev ? data.r : data.u });

            if (session.selected < session.count) {
                updateGuide();
            } else {
                updateGuide();
                setTimeout(showResult, 1500);
            }
        }

        function getLabels(type) {
            const dict = {
                'RESULT': ['結果'],
                'TIMELINE': ['過去', '現在', '未來'],
                'RELATION': ['你本人', '對方', '關係現狀'],
                'CHOICE': ['現狀', '選項A', '選項A結果', '選項B', '選項B結果']
            };
            return dict[type] || ['啟示'];
        }

        // 修改此處以放大字體
        function showResult() {
            guideMsg.style.display = 'none';
            const panel = document.getElementById('result-panel');
            const content = document.getElementById('resContent');
            
            let html = `<h2 style="color:var(--gold); text-align:center; margin:0 0 20px 0; font-size:1.5rem;">占卜結果</h2>`;
            
            session.results.forEach(res => {
                html += `
                <div style="margin-bottom:20px; border-bottom:1px solid rgba(212,175,55,0.2); padding-bottom:15px;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <span style="background:var(--gold); color:black; padding:3px 8px; border-radius:4px; font-size:1rem; font-weight:bold;">${res.label}</span>
                        <b style="color:var(--gold); font-size:1.25rem;">${res.name} (${res.pos})</b>
                    </div>
                    <p style="margin:0; font-size:1.15rem; color:#ccc; line-height:1.5;">${res.desc}</p>
                </div>`;
            });
            content.innerHTML = html;
            panel.style.display = 'block';
        }

        window.onload = init;
    </script>
</body>
</html>